# Render Deployment Guide

## Deployment Configuration

### Files Created for Render:
- `render.yaml` - Render Blueprint configuration
- `Procfile` - Process definition for web service
- `build.sh` - Build script for database migrations
- `runtime.txt` - Python version specification

### Environment Variables Required on Render:

**Database** (automatically configured):
- `DATABASE_URL` - PostgreSQL connection string from Render database

**Flask Configuration**:
- `FLASK_ENV=production`
- `SECRET_KEY` - Auto-generated by Render
- `JWT_SECRET_KEY` - Auto-generated by Render

**API Keys** (add manually in Render dashboard):
- `FINNHUB_API_KEY` - Stock data API
- `TWELVE_DATA_API_KEY` - Backup stock data API
- `ALPHA_VANTAGE_API_KEY` - Third stock data source
- `GOOGLE_API_KEY` - For AI analysis (Gemini)
- `OPENAI_API_KEY` - Alternative AI provider

**Optional**:
- `REDIS_URL` - For caching (if using Redis addon)
- `MAIL_SERVER` - SMTP server for alerts
- `MAIL_PORT` - SMTP port
- `MAIL_USERNAME` - Email username
- `MAIL_PASSWORD` - Email password
- `CORS_ORIGINS` - Comma-separated allowed origins (default: *)

## Deployment Steps:

### 1. Create New Web Service on Render:
- Go to https://dashboard.render.com/
- Click "New +" → "Web Service"
- Connect your GitHub repository
- Render will auto-detect the configuration from `render.yaml`

### 2. Configure Environment Variables:
In Render dashboard → Your service → Environment:
```
FLASK_ENV=production
FINNHUB_API_KEY=your_finnhub_key
TWELVE_DATA_API_KEY=your_twelve_data_key
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key
GOOGLE_API_KEY=your_google_api_key
```

### 3. Database Setup:
Render will automatically:
- Create PostgreSQL database
- Set `DATABASE_URL` environment variable
- Run migrations via `build.sh`

### 4. Deploy:
- Push to GitHub main branch
- Render will automatically build and deploy
- Monitor logs in Render dashboard

## Manual Database Migration (if needed):
```bash
# SSH into Render shell (if available)
flask db upgrade

# Or use Render's web shell
python
>>> from app import create_app, db
>>> app = create_app('production')
>>> with app.app_context():
...     db.create_all()
```

## Health Check:
- Render will ping `/` endpoint to check service health
- Ensure Flask app responds with 200 status

## Logs:
- View logs in Render dashboard
- Or use Render CLI: `render logs -f aktieninspektor`

## Troubleshooting:

### Database Connection Issues:
- Check `DATABASE_URL` format (should be `postgresql://`)
- Verify database service is running
- Check connection string has correct credentials

### Build Failures:
- Check Python version in `runtime.txt` matches Render support
- Verify all dependencies in `requirements.txt` are compatible
- Check build logs for specific errors

### CORS Errors:
- Set `CORS_ORIGINS` to your frontend domain
- For development: `CORS_ORIGINS=*`

### Static Files Not Loading:
- Flask serves static files from `/static/` automatically
- Check Render service is serving from correct directory
- Verify static file paths in templates

## Production Optimizations:

### Gunicorn Workers:
- Current: 4 workers (adjust based on Render plan)
- Formula: `(2 x CPU cores) + 1`

### Database Connection Pool:
- Configured in `config.py` ProductionConfig
- `pool_pre_ping=True` - Check connections before using
- `pool_recycle=300` - Recycle connections every 5 minutes

### Caching:
- Uses simple in-memory cache by default
- Add Redis addon for better performance
- Set `REDIS_URL` environment variable

### Security:
- `SESSION_COOKIE_SECURE=True` - HTTPS only cookies
- `SESSION_COOKIE_HTTPONLY=True` - Prevent XSS
- `SESSION_COOKIE_SAMESITE='Lax'` - CSRF protection

## Render Free Plan Limitations:
- Service spins down after 15 minutes of inactivity
- 750 hours/month (enough for 24/7 with one service)
- PostgreSQL: 1GB storage, 97 connection limit
- First request after spin-down may be slow (cold start)

## Monitoring:
- Render provides basic metrics (CPU, memory, request rate)
- Use external monitoring like UptimeRobot for uptime checks
- Consider logging service for production debugging

## Scaling:
To upgrade from free plan:
1. Go to Render dashboard
2. Select your service
3. Click "Settings" → "Instance Type"
4. Choose paid plan (starts at $7/month)

## Custom Domain:
1. Render dashboard → Your service → Settings
2. Click "Custom Domains"
3. Add your domain
4. Update DNS records as shown
5. SSL certificate auto-provisioned

## Backup Strategy:
- PostgreSQL backups included in paid plans
- Export data regularly via API endpoints
- Consider daily backups to external storage
